title: Oyster Delivery via Teams FakeApp and Script Download Detection
id: abcdef12-3456-7890-abcd-ef1234567890
status: experimental
description: Detects the Oyster delivery via Teams FakeApp by identifying specific HTTP request patterns, including OPTIONS/POST to /create/link and GET to /gov/ paths, as well as GET requests to download-script[0-9]{0,4}.js with Referer starting https://teams-.
author: MalasadaTech
logsource:
  category: firewall
  product: any
detection:
  common:
    http.url|contains: '/create/link'
    http.request.headers.Content-Type: 'application/json'
  options:
    http.method: 'OPTIONS'
  post:
    http.method: 'POST'
    http.request.headers.Content-Encoding: 'msteams'
  gov_selection:
    http.method: 'GET'
    http.url|re: '^/gov/[A-Za-z0-9+/=]+$'
  download_script_selection:
    http.method: 'GET'
    http.url|re: 'download-script[0-9]{0,4}\.js$'
    http.request.headers.Referer|startswith: 'https://teams-'
  condition: (common and (options or post)) or gov_selection or download_script_selection
fields:
  - http.method
  - http.url
  - http.request.headers.Content-Type
  - http.request.headers.Content-Encoding
  - http.request.headers.Referer
falsepositives:
  - Legitimate preflight CORS requests (OPTIONS) or POST requests to /create/link with JSON content type and msteams encoding.
  - Legitimate GET requests to /gov/ paths that match base64 patterns.
  - Legitimate GET requests to download-script[0-9]{0,4}.js with Referer starting https://teams-.
level: low